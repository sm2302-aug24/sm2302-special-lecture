<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="generator" content="quarto-99.9.9">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
<title>2&nbsp; Geographical Information System (GIS) data – SM-2302 Special Lectures</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>

<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./3-quanteda.html" rel="next">
<link href="./1-scraping_linear_reg.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-79bb3942e891885f9f7af119cd221462.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-0fc701aa89f539aeeb882d74ca6374b9.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light"><script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script><script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script><script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script><script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script><link rel="stylesheet" href="styles.css">
</head>
<body class="nav-sidebar floating">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top"><nav class="quarto-secondary-nav"><div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./1-scraping_linear_reg.html">Lectures</a></li><li class="breadcrumb-item"><a href="./2-gis_data.html"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Geographical Information System (GIS) data</span></a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav></header><!-- content --><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto"><div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">SM-2302 Special Lectures</a> 
        <div class="sidebar-tools-main">
    <a href="https://github.com/sm2302-aug24/special-lectures" title="Source Code" class="quarto-navigation-tool px-1" aria-label="Source Code"><i class="bi bi-github"></i></a>
    <a href="./SM-2302-Special-Lectures.pdf" title="Download PDF" class="quarto-navigation-tool px-1" aria-label="Download PDF"><i class="bi bi-file-pdf"></i></a>
</div>
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Welcome</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true">
 <span class="menu-text">Lectures</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./1-scraping_linear_reg.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Data Scraping and Linear Regression</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./2-gis_data.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Geographical Information System (GIS) data</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./3-quanteda.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Quantitative analysis of textual data</span></span></a>
  </div>
</li>
      </ul>
</li>
    </ul>
</div>
</nav><div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active"><h2 id="toc-title">Table of contents</h2>
   
  <ul>
<li><a href="#introduction" id="toc-introduction" class="nav-link active" data-scroll-target="#introduction"><span class="header-section-number">2.1</span> Introduction</a></li>
  <li>
<a href="#multipoint-data" id="toc-multipoint-data" class="nav-link" data-scroll-target="#multipoint-data"><span class="header-section-number">2.2</span> <code>(MULTI)POINT</code> data</a>
  <ul class="collapse">
<li><a href="#clean-up-the-point-data" id="toc-clean-up-the-point-data" class="nav-link" data-scroll-target="#clean-up-the-point-data"><span class="header-section-number">2.2.1</span> Clean up the point data</a></li>
  <li><a href="#preliminary-plot-of-the-data" id="toc-preliminary-plot-of-the-data" class="nav-link" data-scroll-target="#preliminary-plot-of-the-data"><span class="header-section-number">2.2.2</span> Preliminary plot of the data</a></li>
  <li><a href="#merge-with-the-study-data" id="toc-merge-with-the-study-data" class="nav-link" data-scroll-target="#merge-with-the-study-data"><span class="header-section-number">2.2.3</span> Merge with the study data</a></li>
  </ul>
</li>
  <li>
<a href="#line-data-multilinestring" id="toc-line-data-multilinestring" class="nav-link" data-scroll-target="#line-data-multilinestring"><span class="header-section-number">2.3</span> Line data (<code>(MULTI)LINESTRING</code>)</a>
  <ul class="collapse">
<li><a href="#road-networks-in-belait-region" id="toc-road-networks-in-belait-region" class="nav-link" data-scroll-target="#road-networks-in-belait-region"><span class="header-section-number">2.3.1</span> Road networks in Belait region</a></li>
  </ul>
</li>
  <li><a href="#areal-data-multipolygons" id="toc-areal-data-multipolygons" class="nav-link" data-scroll-target="#areal-data-multipolygons"><span class="header-section-number">2.4</span> Areal data (<code>(MULTI)POLYGONS</code>)</a></li>
  <li>
<a href="#openstreetmap-data" id="toc-openstreetmap-data" class="nav-link" data-scroll-target="#openstreetmap-data"><span class="header-section-number">2.5</span> OpenStreetMap data</a>
  <ul class="collapse">
<li><a href="#example-how-to-get-all-the-schools-in-brunei" id="toc-example-how-to-get-all-the-schools-in-brunei" class="nav-link" data-scroll-target="#example-how-to-get-all-the-schools-in-brunei"><span class="header-section-number">2.5.1</span> EXAMPLE: How to get all the schools in Brunei</a></li>
  </ul>
</li>
  </ul></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content"><header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./1-scraping_linear_reg.html">Lectures</a></li><li class="breadcrumb-item"><a href="./2-gis_data.html"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Geographical Information System (GIS) data</span></a></li></ol></nav><div class="quarto-title">
<h1 class="title">
<span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Geographical Information System (GIS) data</span>
</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header><p>Libraries needed:</p>
<div class="cell">
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org">tidyverse</a></span><span class="op">)</span></span>
<span><span class="co"># remotes::install_github("propertypricebn/bruneimap")</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/propertypricebn/bruneimap">bruneimap</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://ggrepel.slowkow.com/">ggrepel</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">kernlab</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/riatelab/osrm">osrm</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://docs.ropensci.org/osmdata/">osmdata</a></span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>More info:</p>
<ul>
<li><a href="https://github.com/propertypricebn/bruneimap">https://github.com/propertypricebn/bruneimap</a></li>
</ul>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>The <a href="https://github.com/propertypricebn/bruneimap">bruneimap</a> package contains the following data sets:</p>
<ol type="1">
<li>
<code>dis_sf</code>: Brunei districts geometries.</li>
<li>
<code>mukim_sf</code>: Brunei mukim geometries.</li>
<li>
<code>kpg_sf</code>: Brunei kampong geometries.</li>
<li>
<code>brn_df</code>: Brunei outline geometries.</li>
<li>
<code>bn_census2021</code>: Brunei 2021 census data.</li>
</ol>
</div>
</div>
<section id="introduction" class="level2" data-number="2.1"><h2 data-number="2.1" class="anchored" data-anchor-id="introduction">
<span class="header-section-number">2.1</span> Introduction</h2>
<div class="callout callout-style-default callout-tip callout-titled" title="What we'll learn">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
What we’ll learn
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li>Types of GIS data and how these are handled in R.</li>
<li>Difference between spatial and non-spatial data analysis.</li>
<li>Importance of geocoding your data for spatial analysis.</li>
</ul>
</div>
</div>
<p>Roughly speaking, there are 4 types of GIS data.</p>
<ol type="1">
<li>
<strong>Points</strong>
<ul>
<li>Having <span class="math inline">\((X, Y)\)</span> coordinates (latitude, longitude, or projected coordinates, and are “zero-dimensional”.</li>
<li>E.g. shopping malls, hospitals, outbreaks, etc.</li>
</ul>
</li>
<li>
<strong>Lines</strong>
<ul>
<li>A collection of points that form a path or a boundary. Has length.</li>
<li>E.g. roads, rivers, pipelines, etc.</li>
</ul>
</li>
<li>
<strong>Polygons</strong>
<ul>
<li>A closed area made up of line segments or curves.</li>
<li>E.g. countries, districts, buildings, etc.</li>
</ul>
</li>
<li>
<strong>Raster</strong>
<ul>
<li>Pixelated (or gridded) data where each pixel is associated with a geographical area and some measurement.</li>
<li>E.g. satellite images, elevation data, etc.</li>
</ul>
</li>
</ol>
<p>The first three are usually referred to as <em>vector data</em>. GIS data can be stored in various formats such as <code>.shp</code> or <code>.geojson</code>. The handling of GIS data (at least vector type data) is facilitated by the <a href="https://r-spatial.github.io/sf/">sf</a> package <span class="citation" data-cites="pebesma2023spatial">(<a href="#ref-pebesma2023spatial" role="doc-biblioref">Pebesma and Bivand 2023</a>)</span> which uses the <em>simple features</em> standard.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p><em>Simple features</em> refers to a formal standard (ISO 19125-1:2004) that describes how objects in the real world can be represented in computers, with emphasis on the spatial geometry of these objects.</p>
</div>
</div>
<p>It’s helpful to think about the shape of this spatial data set. As an example, here’s a random slice of 10 kampong-level population data for Brunei:</p>
<div class="cell">
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span></span>
<span>  <span class="va">kpg_sf</span>, </span>
<span>  <span class="va">bn_census2021</span>, </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/join_by.html">join_by</a></span><span class="op">(</span><span class="va">id</span>, <span class="va">kampong</span>, <span class="va">mukim</span>, <span class="va">district</span><span class="op">)</span></span>
<span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span></span>
<span>    <span class="va">kampong</span>, <span class="va">district</span>, <span class="va">population</span>, <span class="va">geometry</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/slice.html">slice_sample</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">10</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Simple feature collection with 10 features and 3 fields
Geometry type: POLYGON
Dimension:     XY
Bounding box:  xmin: 114.3221 ymin: 4.130862 xmax: 115.2182 ymax: 4.964874
Geodetic CRS:  WGS 84
# A tibble: 10 × 4
   kampong                   district     population                    geometry
   &lt;chr&gt;                     &lt;chr&gt;             &lt;dbl&gt;               &lt;POLYGON [°]&gt;
 1 Kg. Sekurop               Temburong            NA ((115.2135 4.702038, 115.2…
 2 Kg. Kandang               Tutong              300 ((114.649 4.785566, 114.64…
 3 Kg. Long Mayan            Tutong              223 ((114.6515 4.559928, 114.6…
 4 Kg. Pangkalan Sibabau     Brunei Muara        876 ((115.0402 4.962929, 115.0…
 5 Kg. Kasat                 Brunei Muara       1146 ((114.9598 4.848516, 114.9…
 6 Kg. Batang Perhentian     Brunei Muara        346 ((114.8143 4.769514, 114.8…
 7 Kg. Mendaram Kecil        Belait               58 ((114.4898 4.339776, 114.4…
 8 Kg. Kulapis               Brunei Muara       1986 ((114.8251 4.86484, 114.82…
 9 Kg. Dungun                Belait                5 ((114.8444 4.315076, 114.8…
10 Kg. Perpindahan Mata-Mata Brunei Muara       2189 ((114.885 4.892944, 114.88…</code></pre>
</div>
</div>
<p>Spatial data analysis must have these two components:</p>
<ol type="1">
<li>The study variables (in the above example, this is population data).</li>
<li>GIS data regarding that study variable.</li>
</ol>
<p>If we only have 1 without 2, then it really is just a regular data analysis (stating the obvious). Adding the GIS data is a process called “geocoding” the data points.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>In R, geocoding using <a href="https://tidyverse.tidyverse.org">tidyverse</a> can be achieved using the <code><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">dplyr::left_join()</a></code> or similar <code>xxx_join()</code> family of functions.</p>
</div>
</div>
</section><section id="multipoint-data" class="level2" data-number="2.2"><h2 data-number="2.2" class="anchored" data-anchor-id="multipoint-data">
<span class="header-section-number">2.2</span> <code>(MULTI)POINT</code> data</h2>
<div class="callout callout-style-default callout-tip callout-titled" title="What we'll learn">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
What we’ll learn
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li>Loading data sets in R using <code><a href="https://readr.tidyverse.org/reference/read_delim.html">readr::read_csv()</a></code>.</li>
<li>Identifying data types and their implications.</li>
</ul>
</div>
</div>
<p>Use the data from <span class="citation" data-cites="jaafar2023data">Jaafar and Sukri (<a href="#ref-jaafar2023data" role="doc-biblioref">2023</a>)</span> on the physicochemical characteristics and texture classification of soil in Bornean tropical heath forests affected by exotic Acacia mangium. There are three datasets provided.</p>
<ol type="1">
<li>GIS data (<a href="https://en.wikipedia.org/wiki/World_Geodetic_System" title="World Geodetic System">WGS84</a> coordinates) of all study plots.</li>
<li>Soil physicochemical property data. This contains details of soil physical, chemical, nutrient concentration of the three habits studied.</li>
<li>Soil texture classification. Provides details on the classification of the soil texture in the habitats studied.</li>
</ol>
<p>We will first load the data sets in R.</p>
<div class="cell">
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Load the data sets</span></span>
<span><span class="va">soil_gps</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://readr.tidyverse.org/reference/read_delim.html">read_csv</a></span><span class="op">(</span></span>
<span>  <span class="st">"data/8389823/GPS - Revised.csv"</span>, </span>
<span>  <span class="co"># IMPORTANT!!! The csv file has latin1 encoding as opposed to UTF-8</span></span>
<span>  locale <span class="op">=</span> <span class="fu">readr</span><span class="fu">::</span><span class="fu"><a href="https://readr.tidyverse.org/reference/locale.html">locale</a></span><span class="op">(</span>encoding <span class="op">=</span> <span class="st">"latin1"</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span>  </span>
<span><span class="va">soil_physico</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://readr.tidyverse.org/reference/read_delim.html">read_csv</a></span><span class="op">(</span><span class="st">"data/8389823/Soil physicochemical properties.csv"</span><span class="op">)</span></span>
<span><span class="va">soil_texture</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://readr.tidyverse.org/reference/read_delim.html">read_csv</a></span><span class="op">(</span><span class="st">"data/8389823/Soil texture classification.csv"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="clean-up-the-point-data" class="level3" data-number="2.2.1"><h3 data-number="2.2.1" class="anchored" data-anchor-id="clean-up-the-point-data">
<span class="header-section-number">2.2.1</span> Clean up the point data</h3>
<div class="callout callout-style-default callout-tip callout-titled" title="What we'll learn">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
What we’ll learn
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li>Highlighting the need for cleaning and preprocessing data.</li>
<li>Using <code><a href="https://pillar.r-lib.org/reference/glimpse.html">glimpse()</a></code> to peek at the data.</li>
<li>Using <code><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate()</a></code> to change stuff in the data set.</li>
<li>Using <code><a href="https://rdrr.io/r/utils/str.html">str()</a></code> to look at the structure of an R object.</li>
</ul>
</div>
</div>
<p>Let’s take a look at the point data set.</p>
<div class="cell">
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://pillar.r-lib.org/reference/glimpse.html">glimpse</a></span><span class="op">(</span><span class="va">soil_gps</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Rows: 18
Columns: 5
$ Forest_type  &lt;chr&gt; "Kerangas", "Kerangas", "Kerangas", "Kerangas", "Kerangas…
$ Habitat_type &lt;chr&gt; "Intact", "Intact", "Intact", "Intact", "Intact", "Intact…
$ Plot_name    &lt;chr&gt; "KU1", "KU2", "KU3", "KU4", "KU5", "KU6", "KI1", "KI2", "…
$ Latitude     &lt;chr&gt; "4° 35' 53.40\"N", "4° 35' 38.37\"N", "4° 35' 53.89\"N", …
$ Longitude    &lt;chr&gt; "114° 30' 39.09\"E", "114° 31' 05.89\"E", "114° 30' 38.90…</code></pre>
</div>
</div>
<p>The first three columns are essentially the identifiers of the plots (forest type, habitat type, and the unique identification code for the study plot). However, the latitude and longitude needs a bit of cleaning up, because it’s currently in character format. This needs to be in a formal Degree Minute Second <code>DMS</code> class that R can understand. For this we will use the <code><a href="https://edzer.github.io/sp/reference/char2dms.html">sp::char2dms()</a></code> function.</p>
<p>As an example let’s take a look at the first latitude.</p>
<div class="cell">
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">x</span> <span class="op">&lt;-</span> <span class="va">soil_gps</span><span class="op">$</span><span class="va">Latitude</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span></span>
<span><span class="va">x</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "4° 35' 53.40\"N"</code></pre>
</div>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># convert it using sp::char2dms() function</span></span>
<span><span class="va">x</span> <span class="op">&lt;-</span> <span class="fu">sp</span><span class="fu">::</span><span class="fu"><a href="https://edzer.github.io/sp/reference/char2dms.html">char2dms</a></span><span class="op">(</span><span class="va">x</span>, chd <span class="op">=</span> <span class="st">"°"</span><span class="op">)</span></span>
<span><span class="va">x</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 4d35'53.4"N</code></pre>
</div>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/str.html">str</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Formal class 'DMS' [package "sp"] with 5 slots
  ..@ WS : logi FALSE
  ..@ deg: int 4
  ..@ min: int 35
  ..@ sec: num 53.4
  ..@ NS : logi TRUE</code></pre>
</div>
</div>
<p>This is a special class that R understands as being a latitude from Earth. To convert it to decimal, we just do <code><a href="https://rdrr.io/r/base/numeric.html">as.numeric()</a></code>:</p>
<div class="cell">
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 4.598167</code></pre>
</div>
</div>
<p>Now let’s do this for all the values in the <code>soil_gps</code> data. We will use the <code><a href="https://dplyr.tidyverse.org/reference/mutate.html">dplyr::mutate()</a></code> function in a pipeline.</p>
<div class="cell">
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">soil_gps</span> <span class="op">&lt;-</span></span>
<span>  <span class="va">soil_gps</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span></span>
<span>    Latitude <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="fu">sp</span><span class="fu">::</span><span class="fu"><a href="https://edzer.github.io/sp/reference/char2dms.html">char2dms</a></span><span class="op">(</span><span class="va">Latitude</span>, chd <span class="op">=</span> <span class="st">"°"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    Longitude <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="fu">sp</span><span class="fu">::</span><span class="fu"><a href="https://edzer.github.io/sp/reference/char2dms.html">char2dms</a></span><span class="op">(</span><span class="va">Longitude</span>, chd <span class="op">=</span> <span class="st">"°"</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="va">soil_gps</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 18 × 5
   Forest_type Habitat_type Plot_name Latitude Longitude
   &lt;chr&gt;       &lt;chr&gt;        &lt;chr&gt;        &lt;dbl&gt;     &lt;dbl&gt;
 1 Kerangas    Intact       KU1           4.60      115.
 2 Kerangas    Intact       KU2           4.59      115.
 3 Kerangas    Intact       KU3           4.60      115.
 4 Kerangas    Intact       KU4           4.63      114.
 5 Kerangas    Intact       KU5           4.60      115.
 6 Kerangas    Intact       KU6           4.60      115.
 7 Kerangas    Invaded      KI1           4.59      115.
 8 Kerangas    Invaded      KI2           4.59      115.
 9 Kerangas    Invaded      KI3           4.59      115.
10 Kerangas    Invaded      KI4           4.59      115.
11 Kerangas    Invaded      KI5           4.59      115.
12 Kerangas    Invaded      KI6           4.59      115.
13 Kerangas    Plantation   AP1           4.59      115.
14 Kerangas    Plantation   AP2           4.59      115.
15 Kerangas    Plantation   AP3           4.59      115.
16 Kerangas    Plantation   AP4           4.59      115.
17 Kerangas    Plantation   AP5           4.59      115.
18 Kerangas    Plantation   AP6           4.59      115.</code></pre>
</div>
</div>
</section><section id="preliminary-plot-of-the-data" class="level3" data-number="2.2.2"><h3 data-number="2.2.2" class="anchored" data-anchor-id="preliminary-plot-of-the-data">
<span class="header-section-number">2.2.2</span> Preliminary plot of the data</h3>
<div class="callout callout-style-default callout-tip callout-titled" title="What we'll learn">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
What we’ll learn
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li>Structure of a <code><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot()</a></code> (grammar of graphics).</li>
<li>Using <code><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">geom_sf()</a></code> to plot the GIS data, and adding points using <code><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point()</a></code>.</li>
</ul>
</div>
</div>
<p>Using the data contained in the <a href="https://github.com/propertypricebn/bruneimap">bruneimap</a> package, we can plot the study areas on a map of Brunei. Use either the <code>brn_sf</code>, <code>dis_sf</code>, <code>mkm_sf</code> or <code>kpg_sf</code> data sets.</p>
<div class="cell">
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">brn_sf</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">geom_sf</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">soil_gps</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span><span class="va">Longitude</span>, <span class="va">Latitude</span><span class="op">)</span><span class="op">)</span> </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="2-gis_data_files/figure-html/unnamed-chunk-8-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>We can zoom in a bit… but we have to find out manually the correct bounding box. To do this, we can either:</p>
<ol type="1">
<li>Manually find the minimum and maximum values of the latitude and longitude.</li>
<li>Convert the <code>soil_gps</code> data set to an <code>sf</code> object and use the <code><a href="https://r-spatial.github.io/sf/reference/st_bbox.html">st_bbox()</a></code> function.</li>
</ol>
<div class="cell">
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Manual way</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span></span>
<span>  xmin <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="va">soil_gps</span><span class="op">$</span><span class="va">Longitude</span><span class="op">)</span>, xmax <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">soil_gps</span><span class="op">$</span><span class="va">Longitude</span><span class="op">)</span>,</span>
<span>  ymin <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="va">soil_gps</span><span class="op">$</span><span class="va">Latitude</span><span class="op">)</span>, ymax <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">soil_gps</span><span class="op">$</span><span class="va">Latitude</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>      xmin       xmax       ymin       ymax 
114.473356 114.529297   4.592817   4.630242 </code></pre>
</div>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Using the sf object</span></span>
<span><span class="va">soil_sf</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_as_sf.html">st_as_sf</a></span><span class="op">(</span><span class="va">soil_gps</span>, coords <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Longitude"</span>, <span class="st">"Latitude"</span><span class="op">)</span>, crs <span class="op">=</span> <span class="fl">4326</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_bbox.html">st_bbox</a></span><span class="op">(</span><span class="va">soil_sf</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>      xmin       ymin       xmax       ymax 
114.473356   4.592817 114.529297   4.630242 </code></pre>
</div>
</div>
<p>Now that we’ve found the bound box, we can plot better:</p>
<div class="cell">
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">mkm_sf</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">geom_sf</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">geom_sf</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">dis_sf</span>, fill <span class="op">=</span> <span class="cn">NA</span>, col <span class="op">=</span> <span class="st">"black"</span>, linewidth <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">soil_gps</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span><span class="va">Longitude</span>, <span class="va">Latitude</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggrepel.slowkow.com/reference/geom_text_repel.html">geom_text_repel</a></span><span class="op">(</span></span>
<span>    data <span class="op">=</span> <span class="va">soil_gps</span>,</span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span><span class="va">Longitude</span>, <span class="va">Latitude</span>, label <span class="op">=</span> <span class="va">Plot_name</span><span class="op">)</span>,</span>
<span>    box.padding <span class="op">=</span> <span class="fl">0.5</span>,</span>
<span>    max.overlaps <span class="op">=</span> <span class="fl">30</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">coord_sf</a></span><span class="op">(</span></span>
<span>    xlim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">114.4</span>, <span class="fl">114.6</span><span class="op">)</span>,</span>
<span>    ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">4.5</span>, <span class="fl">4.7</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="2-gis_data_files/figure-html/unnamed-chunk-10-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section><section id="merge-with-the-study-data" class="level3" data-number="2.2.3"><h3 data-number="2.2.3" class="anchored" data-anchor-id="merge-with-the-study-data">
<span class="header-section-number">2.2.3</span> Merge with the study data</h3>
<div class="callout callout-style-default callout-tip callout-titled" title="What we'll learn">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
What we’ll learn
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li>Using <code><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join()</a></code> to merge two data sets together.</li>
<li>Using <code><a href="https://ggplot2.tidyverse.org/reference/geom_jitter.html">geom_jitter()</a></code> to plot the study variables that are overlapping.</li>
</ul>
</div>
</div>
<p>Let’s take a look at the data set.</p>
<div class="cell">
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://pillar.r-lib.org/reference/glimpse.html">glimpse</a></span><span class="op">(</span><span class="va">soil_physico</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Rows: 144
Columns: 16
$ Habitat_type              &lt;chr&gt; "Intact", "Intact", "Intact", "Intact", "Int…
$ Plot_name                 &lt;chr&gt; "KU1", "KU1", "KU1", "KU1", "KU1", "KU1", "K…
$ Subplot_name              &lt;chr&gt; "A", "A", "B", "B", "C", "C", "D", "D", "A",…
$ Soil_depth                &lt;chr&gt; "0-15", "30-50", "0-15", "30-50", "0-15", "3…
$ Nitrogen                  &lt;dbl&gt; 0.617, 0.188, 0.663, 0.200, 0.465, 0.255, 0.…
$ Phosphorus                &lt;dbl&gt; 0.248, 0.129, 0.259, 0.295, 0.172, 0.145, 0.…
$ Magnesium                 &lt;dbl&gt; 0.000, 0.045, 0.054, 0.035, 0.079, 0.043, 0.…
$ Calcium                   &lt;dbl&gt; 0.167, 0.187, 0.148, 0.113, 0.253, 0.229, 0.…
$ Potassium                 &lt;dbl&gt; 0.059, 0.037, 0.054, 0.022, 0.098, 0.033, 0.…
$ Exchangable_magnesium     &lt;dbl&gt; 0.009, 0.004, 0.007, 0.005, 0.029, 0.014, 0.…
$ Exchangable_calcium       &lt;dbl&gt; 0.010, 0.009, 0.008, 0.009, 0.109, 0.041, 0.…
$ Exchangable_potassium     &lt;dbl&gt; 0.101, 0.085, 0.092, 0.087, 0.101, 0.090, 0.…
$ Available_phosphorus      &lt;dbl&gt; 0.012, 0.012, 0.013, 0.012, 0.013, 0.014, 0.…
$ pH                        &lt;dbl&gt; 2.3, 2.7, 2.0, 2.0, 2.6, 2.5, 2.3, 2.1, 1.0,…
$ Gravimetric_water_content &lt;dbl&gt; 5.911, 3.560, 10.860, 5.082, 6.963, 4.549, 5…
$ Organic_matter            &lt;dbl&gt; 4.559, 1.399, 4.523, 2.309, 3.131, 2.209, 3.…</code></pre>
</div>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://pillar.r-lib.org/reference/glimpse.html">glimpse</a></span><span class="op">(</span><span class="va">soil_texture</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Rows: 144
Columns: 8
$ Habitat_type           &lt;chr&gt; "Intact", "Intact", "Intact", "Intact", "Intact…
$ Plot_name              &lt;chr&gt; "KU1", "KU1", "KU1", "KU1", "KU2", "KU2", "KU2"…
$ Subplot_name           &lt;chr&gt; "A", "B", "C", "D", "A", "B", "C", "D", "A", "B…
$ Soil_depth             &lt;chr&gt; "0-15", "0-15", "0-15", "0-15", "0-15", "0-15",…
$ Clay                   &lt;dbl&gt; 0.0, 0.0, 0.0, 0.0, 0.0, 2.5, 2.5, 2.5, 0.0, 2.…
$ Silt                   &lt;dbl&gt; 2.5, 0.0, 0.0, 2.5, 0.0, 0.0, 2.5, 2.5, 7.5, 7.…
$ Sand                   &lt;dbl&gt; 97.5, 100.0, 100.0, 97.5, 100.0, 97.5, 95.0, 95…
$ Texture_classification &lt;chr&gt; "Sand", "Sand", "Sand", "Sand", "Sand", "Sand",…</code></pre>
</div>
</div>
<p>The <code>soil_physico</code> and <code>soil_texture</code> data sets contain the same columns, so we might as well merge them together. We will use the <code><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">dplyr::left_join()</a></code> function.</p>
<div class="cell">
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Actually I just want to merge these two together</span></span>
<span><span class="va">soil_df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span></span>
<span>  <span class="va">soil_physico</span>,</span>
<span>  <span class="va">soil_texture</span>,</span>
<span>  by <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/join_by.html">join_by</a></span><span class="op">(</span><span class="va">Habitat_type</span>, <span class="va">Plot_name</span>, <span class="va">Subplot_name</span>, <span class="va">Soil_depth</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="va">soil_df</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 144 × 20
   Habitat_type Plot_name Subplot_name Soil_depth Nitrogen Phosphorus Magnesium
   &lt;chr&gt;        &lt;chr&gt;     &lt;chr&gt;        &lt;chr&gt;         &lt;dbl&gt;      &lt;dbl&gt;     &lt;dbl&gt;
 1 Intact       KU1       A            0-15          0.617      0.248     0    
 2 Intact       KU1       A            30-50         0.188      0.129     0.045
 3 Intact       KU1       B            0-15          0.663      0.259     0.054
 4 Intact       KU1       B            30-50         0.2        0.295     0.035
 5 Intact       KU1       C            0-15          0.465      0.172     0.079
 6 Intact       KU1       C            30-50         0.255      0.145     0.043
 7 Intact       KU1       D            0-15          0.285      0.225     0.052
 8 Intact       KU1       D            30-50         0.057      0.207     0.031
 9 Intact       KU2       A            0-15          0.37       0.135     0.038
10 Intact       KU2       A            30-50         0.114      0.168     0.021
# ℹ 134 more rows
# ℹ 13 more variables: Calcium &lt;dbl&gt;, Potassium &lt;dbl&gt;,
#   Exchangable_magnesium &lt;dbl&gt;, Exchangable_calcium &lt;dbl&gt;,
#   Exchangable_potassium &lt;dbl&gt;, Available_phosphorus &lt;dbl&gt;, pH &lt;dbl&gt;,
#   Gravimetric_water_content &lt;dbl&gt;, Organic_matter &lt;dbl&gt;, Clay &lt;dbl&gt;,
#   Silt &lt;dbl&gt;, Sand &lt;dbl&gt;, Texture_classification &lt;chr&gt;</code></pre>
</div>
</div>
<p>Once we’ve done that, the <code>soil_df</code> data set (the study variables) is actually missing the spatial data. We need to geocode it with the <code>soil_gps</code> data set. Again, <code><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">dplyr::left_join()</a></code> to the rescue!</p>
<div class="cell">
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">soil_df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span></span>
<span>  <span class="va">soil_df</span>, </span>
<span>  <span class="va">soil_gps</span>,</span>
<span>  by <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/join_by.html">join_by</a></span><span class="op">(</span><span class="va">Habitat_type</span>, <span class="va">Plot_name</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now we’re in a position to plot the study variables on the map. Note that there are only 18 plots in the <code>soil_gps</code> data set, and each plot has repeated measurements. That means when we plot it, it will overlap and look like a single point. So a good thing to do is to jitter the point so it’s easier to see.</p>
<div class="cell">
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">kpg_sf</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">geom_sf</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_jitter.html">geom_jitter</a></span><span class="op">(</span></span>
<span>    data <span class="op">=</span> <span class="va">soil_df</span>, </span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span><span class="va">Longitude</span>, <span class="va">Latitude</span>, col <span class="op">=</span> <span class="va">Nitrogen</span>, size <span class="op">=</span> <span class="va">Nitrogen</span>, </span>
<span>        shape <span class="op">=</span> <span class="va">Habitat_type</span><span class="op">)</span>,</span>
<span>    width <span class="op">=</span> <span class="fl">0.001</span>, height <span class="op">=</span> <span class="fl">0.001</span>, alpha <span class="op">=</span> <span class="fl">0.7</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">coord_sf</a></span><span class="op">(</span></span>
<span>    xlim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">114.46</span>, <span class="fl">114.54</span><span class="op">)</span>,</span>
<span>    ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">4.58</span>, <span class="fl">4.64</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_viridis.html">scale_color_viridis_c</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guides.html">guides</a></span><span class="op">(</span>size <span class="op">=</span> <span class="st">"none"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="2-gis_data_files/figure-html/unnamed-chunk-14-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section></section><section id="line-data-multilinestring" class="level2" data-number="2.3"><h2 data-number="2.3" class="anchored" data-anchor-id="line-data-multilinestring">
<span class="header-section-number">2.3</span> Line data (<code>(MULTI)LINESTRING</code>)</h2>
<div class="callout callout-style-default callout-tip callout-titled" title="What we'll learn">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
What we’ll learn
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li>How to load spatial data sets using <code><a href="https://r-spatial.github.io/sf/reference/st_read.html">sf::read_sf()</a></code> and editing the CRS using <code><a href="https://r-spatial.github.io/sf/reference/st_transform.html">sf::st_transform()</a></code>.</li>
<li>How to filter data using <code><a href="https://dplyr.tidyverse.org/reference/filter.html">dplyr::filter()</a></code>.</li>
<li>How to plot line data using <code><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">ggplot2::geom_sf()</a></code>.</li>
</ul>
</div>
</div>
<p>For this example, we’ll play with the road network shape file obtained from OpenStreetMaps. The data is in geojson format, so let’s import that into R.</p>
<div class="cell">
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">brd</span> <span class="op">&lt;-</span> </span>
<span>  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_read.html">read_sf</a></span><span class="op">(</span><span class="st">"data/hotosm_brn_roads_lines_geojson/hotosm_brn_roads_lines_geojson.geojson"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_transform.html">st_transform</a></span><span class="op">(</span><span class="fl">4326</span><span class="op">)</span>  <span class="co"># SET THE CRS!!! (WGS84)</span></span>
<span><span class="fu"><a href="https://pillar.r-lib.org/reference/glimpse.html">glimpse</a></span><span class="op">(</span><span class="va">brd</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Rows: 25,570
Columns: 15
$ name       &lt;chr&gt; "Simpang 393", "Simpang 405", NA, NA, NA, NA, "Lebuhraya Tu…
$ `name:en`  &lt;chr&gt; NA, NA, NA, NA, NA, NA, "Tutong–Telisai Highway", NA, NA, N…
$ highway    &lt;chr&gt; "residential", "residential", "service", "residential", "tr…
$ surface    &lt;chr&gt; NA, NA, NA, NA, NA, "asphalt", "asphalt", NA, NA, NA, "asph…
$ smoothness &lt;chr&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,…
$ width      &lt;chr&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,…
$ lanes      &lt;chr&gt; NA, NA, NA, NA, NA, "1", "2", NA, NA, NA, "2", NA, NA, NA, …
$ oneway     &lt;chr&gt; NA, NA, NA, NA, NA, "yes", "yes", NA, NA, NA, "no", "yes", …
$ bridge     &lt;chr&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,…
$ layer      &lt;chr&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,…
$ source     &lt;chr&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,…
$ `name:ms`  &lt;chr&gt; NA, NA, NA, NA, NA, NA, "Lebuhraya Tutong–Telisai", NA, NA,…
$ osm_id     &lt;int&gt; 386886618, 481030903, 512405939, 664532755, 442044892, 6651…
$ osm_type   &lt;chr&gt; "ways_line", "ways_line", "ways_line", "ways_line", "ways_l…
$ geometry   &lt;LINESTRING [°]&gt; LINESTRING (114.6236 4.7910..., LINESTRING (114.…</code></pre>
</div>
</div>
<p>There are 25,570 features in this data set, which may be a bit too much. Let’s try to focus on the major roads only. This information seems to be contained in the <code>highway</code> column. What’s in it?</p>
<div class="cell">
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span><span class="op">(</span><span class="va">brd</span><span class="op">$</span><span class="va">highway</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
     bridleway   construction       cycleway        footway  living_street 
             1             28             73            898             10 
      motorway  motorway_link           path     pedestrian        primary 
           116            152            140             60            865 
  primary_link    residential           road      secondary secondary_link 
           332           9023              1            446             79 
       service          steps       tertiary  tertiary_link          track 
          9876             53            586             59            442 
         trunk     trunk_link   unclassified 
           460            310           1560 </code></pre>
</div>
</div>
<p>According to this <a href="https://wiki.openstreetmap.org/wiki/OpenStreetMap_Carto/Lines">wiki</a>, In OpenStreetMap, the major roads of a road network are sorted on an importance scale, from motorway to quaternary road.</p>
<p><img src="figures/osm_roads.png" class="img-fluid"></p>
<div class="cell">
<div class="sourceCode" id="cb35"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">brd_mjr</span> <span class="op">&lt;-</span> </span>
<span>  <span class="va">brd</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">highway</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"motorway"</span>, <span class="st">"trunk"</span>, <span class="st">"primary"</span>, <span class="st">"secondary"</span><span class="op">)</span><span class="op">)</span> </span>
<span><span class="va">brd_mjr</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Simple feature collection with 1887 features and 14 fields
Geometry type: LINESTRING
Dimension:     XY
Bounding box:  xmin: 114.1906 ymin: 4.516642 xmax: 115.2021 ymax: 5.037115
Geodetic CRS:  WGS 84
# A tibble: 1,887 × 15
   name     `name:en` highway surface smoothness width lanes oneway bridge layer
 * &lt;chr&gt;    &lt;chr&gt;     &lt;chr&gt;   &lt;chr&gt;   &lt;chr&gt;      &lt;chr&gt; &lt;chr&gt; &lt;chr&gt;  &lt;chr&gt;  &lt;chr&gt;
 1 Lebuhra… Tutong–T… trunk   asphalt &lt;NA&gt;       &lt;NA&gt;  2     yes    &lt;NA&gt;   &lt;NA&gt; 
 2 Lebuhra… Tutong–T… trunk   asphalt &lt;NA&gt;       &lt;NA&gt;  3     yes    &lt;NA&gt;   &lt;NA&gt; 
 3 Jalan S… &lt;NA&gt;      primary asphalt &lt;NA&gt;       &lt;NA&gt;  2     yes    yes    1    
 4 Jalan S… &lt;NA&gt;      primary asphalt &lt;NA&gt;       &lt;NA&gt;  2     yes    &lt;NA&gt;   &lt;NA&gt; 
 5 Lebuh R… Seria–Be… trunk   asphalt &lt;NA&gt;       &lt;NA&gt;  2     yes    &lt;NA&gt;   &lt;NA&gt; 
 6 &lt;NA&gt;     &lt;NA&gt;      trunk   asphalt &lt;NA&gt;       &lt;NA&gt;  2     yes    &lt;NA&gt;   &lt;NA&gt; 
 7 &lt;NA&gt;     &lt;NA&gt;      primary asphalt &lt;NA&gt;       &lt;NA&gt;  1     yes    &lt;NA&gt;   &lt;NA&gt; 
 8 Lebuh R… Seria–Be… trunk   asphalt &lt;NA&gt;       &lt;NA&gt;  2     yes    yes    1    
 9 &lt;NA&gt;     &lt;NA&gt;      primary asphalt &lt;NA&gt;       &lt;NA&gt;  2     yes    &lt;NA&gt;   &lt;NA&gt; 
10 Lebuhra… Telisai–… trunk   asphalt &lt;NA&gt;       &lt;NA&gt;  2     yes    &lt;NA&gt;   &lt;NA&gt; 
# ℹ 1,877 more rows
# ℹ 5 more variables: source &lt;chr&gt;, `name:ms` &lt;chr&gt;, osm_id &lt;int&gt;,
#   osm_type &lt;chr&gt;, geometry &lt;LINESTRING [°]&gt;</code></pre>
</div>
</div>
<p>And now a plot of these roads.</p>
<div class="cell">
<div class="sourceCode" id="cb37"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">geom_sf</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">brn_sf</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">geom_sf</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">brd_mjr</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>col <span class="op">=</span> <span class="va">highway</span><span class="op">)</span>, size <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="co"># scale_colour_viridis_d(option = "turbo")</span></span>
<span>  <span class="fu">ggsci</span><span class="fu">::</span><span class="fu"><a href="https://nanx.me/ggsci/reference/scale_npg.html">scale_colour_npg</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="2-gis_data_files/figure-html/unnamed-chunk-18-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>With this, I asked ChatGPT what kind of spatial analyses can be done on this data set. It said, when paired with appropriate data, we can do things like:</p>
<ol type="1">
<li>
<strong>Network Connectivity Analysis</strong>
<ul>
<li>Assess reachability and identify disconnected road network components.</li>
</ul>
</li>
<li>
<strong>Accessibility and Service Area Analysis</strong>
<ul>
<li>Determine service areas and catchment areas for essential services.</li>
</ul>
</li>
<li>
<strong>Traffic Simulation and Management</strong>
<ul>
<li>Simulate traffic flow to identify bottlenecks and suggest optimal routing.</li>
</ul>
</li>
<li>
<strong>Environmental Impact Assessment</strong>
<ul>
<li>Estimate vehicular emissions and model noise pollution from roads.</li>
</ul>
</li>
<li>
<strong>Urban and Regional Planning</strong>
<ul>
<li>Examine land use compatibility and assess infrastructure development needs.</li>
</ul>
</li>
<li>
<strong>Safety Analysis</strong>
<ul>
<li>Identify accident hotspots and assess pedestrian safety.</li>
</ul>
</li>
<li>
<strong>Economic Analysis</strong>
<ul>
<li>Evaluate economic accessibility and the impact of road projects.</li>
</ul>
</li>
</ol>
<p>Let’s pick one of these: Calculate the distance between the centroid of several regions and the major hospital in the Belait district. This analysis guides urban and healthcare planning by pinpointing areas with inadequate access to emergency services, enabling targeted infrastructure and service improvements.</p>
<section id="road-networks-in-belait-region" class="level3" data-number="2.3.1"><h3 data-number="2.3.1" class="anchored" data-anchor-id="road-networks-in-belait-region">
<span class="header-section-number">2.3.1</span> Road networks in Belait region</h3>
<div class="callout callout-style-default callout-tip callout-titled" title="What we'll learn">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
What we’ll learn
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li>Manipulating GIS data using <code><a href="https://r-spatial.github.io/sf/reference/geos_binary_ops.html">sf::st_intersection()</a></code> and the like. Useful for reorganising the spatial structure (without having to do this in QGIS or ArcGIS).</li>
<li>Sampling points from a line data set.</li>
<li>Calculating distances between points and lines using <a href="https://github.com/riatelab/osrm">osrm</a> package.</li>
</ul>
</div>
</div>
<p>First we “crop” the road network to the Belait region.</p>
<div class="cell">
<div class="sourceCode" id="cb38"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">brd_belait</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_binary_ops.html">st_intersection</a></span><span class="op">(</span></span>
<span>  <span class="va">brd</span>,</span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">dis_sf</span>, <span class="va">name</span> <span class="op">==</span> <span class="st">"Belait"</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: attribute variables are assumed to be spatially constant throughout
all geometries</code></pre>
</div>
<div class="sourceCode" id="cb40"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">brd_belait</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">geom_sf</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">geom_sf</a></span><span class="op">(</span>data <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">dis_sf</span>, <span class="va">name</span> <span class="op">==</span> <span class="st">"Belait"</span><span class="op">)</span>, fill <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="2-gis_data_files/figure-html/unnamed-chunk-19-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>If we were to sample random points from the Belait polygon, we might get non-sensical areas like the extremely rural areas or forest reserves. So the idea is to sample random points from the road network itself. For this, we need a function that will get us a random point on the path itself.</p>
<div class="cell">
<div class="sourceCode" id="cb41"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">get_random_point</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">linestring</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">coords</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_coordinates.html">st_coordinates</a></span><span class="op">(</span><span class="va">linestring</span><span class="op">)</span></span>
<span>  <span class="va">samp_coord</span> <span class="op">&lt;-</span> <span class="va">coords</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">coords</span><span class="op">)</span>, <span class="fl">1</span><span class="op">)</span>, , drop <span class="op">=</span> <span class="cn">FALSE</span><span class="op">]</span></span>
<span>  <span class="va">samp_coord</span><span class="op">[</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">3</span><span class="op">]</span></span>
<span><span class="op">}</span></span>
<span><span class="fu">get_random_point</span><span class="op">(</span><span class="va">brd_belait</span><span class="op">$</span><span class="va">geometry</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>         X          Y         L1 
114.241941   4.594271   1.000000 </code></pre>
</div>
</div>
<p>Once we have this function, we need to <code><a href="https://purrr.tidyverse.org/reference/map.html">map()</a></code> this function onto each of the linestrings in the <code>brd_belait</code> data set. The resulting list of points is too large! So we will just sample 100 points (you can experiment with this number).</p>
<div class="cell">
<div class="sourceCode" id="cb43"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">random_points</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map</a></span><span class="op">(</span><span class="va">brd_belait</span><span class="op">$</span><span class="va">geometry</span>, <span class="va">get_random_point</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html">bind_rows</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/slice.html">slice_sample</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">100</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>What we have now is a data frame of 100 random points on the road network in the Belait district. We will use the <a href="https://github.com/riatelab/osrm">osrm</a> package to calculate the distance between these points and the Suri Seri Begawan Hospital in Kuala Belait. The output will be three things: 1) The duration (minutes); 2) The distance (km); and 3) a <code>LINESTRING</code> object that represents the path to get to the hospital. Unfortunately the <code><a href="https://rdrr.io/pkg/osrm/man/osrmRoute.html">osrmRoute()</a></code> function is not vectorised, i.e.&nbsp;we have to do it one-by-one for each of the 100 points. Luckily, we can just make a <code>for</code> loop and store the results in a list.</p>
<div class="cell">
<div class="sourceCode" id="cb44"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">suriseri</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">114.198778</span>, <span class="fl">4.583444</span><span class="op">)</span></span>
<span></span>
<span><span class="va">res</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fl">100</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">res</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/osrm/man/osrmRoute.html">osrmRoute</a></span><span class="op">(</span>src <span class="op">=</span> <span class="va">random_points</span><span class="op">[</span><span class="va">i</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">2</span><span class="op">]</span>, dst <span class="op">=</span> <span class="va">suriseri</span>, overview <span class="op">=</span> <span class="st">"full"</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="va">res</span> <span class="op">&lt;-</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html">bind_rows</a></span><span class="op">(</span><span class="va">res</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html">as_tibble</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_as_sf.html">st_as_sf</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">res</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Simple feature collection with 100 features and 4 fields
Geometry type: LINESTRING
Dimension:     XY
Bounding box:  xmin: 114.1916 ymin: 4.26484 xmax: 114.6695 ymax: 4.69454
Geodetic CRS:  WGS 84
# A tibble: 100 × 5
   src   dst   duration distance                                        geometry
   &lt;chr&gt; &lt;chr&gt;    &lt;dbl&gt;    &lt;dbl&gt;                                &lt;LINESTRING [°]&gt;
 1 1     dst      35.0    38.1   (114.4903 4.65616, 114.4903 4.65616, 114.4902 …
 2 1     dst      17.8    18.8   (114.3396 4.60221, 114.3396 4.60221, 114.3395 …
 3 1     dst       8.10    5.43  (114.226 4.5769, 114.226 4.5769, 114.2265 4.57…
 4 1     dst      20.1    22.9   (114.369 4.60327, 114.3693 4.60334, 114.3695 4…
 5 1     dst       3.15    1.69  (114.2079 4.583, 114.2079 4.583, 114.2078 4.58…
 6 1     dst      11.6     8.65  (114.2707 4.6001, 114.2707 4.60007, 114.2707 4…
 7 1     dst      30.2    36.0   (114.4696 4.6594, 114.4696 4.6594, 114.4698 4.…
 8 1     dst       2.11    0.955 (114.1918 4.5838, 114.1921 4.58362, 114.1922 4…
 9 1     dst       3.49    1.90  (114.2096 4.58314, 114.2096 4.58326, 114.2094 …
10 1     dst       1.52    0.618 (114.2007 4.58641, 114.2007 4.58641, 114.2007 …
# ℹ 90 more rows</code></pre>
</div>
</div>
<p>So with all that done, we can now plot the paths taken by the 100 random points to the hospital. The map gives us an indication of which areas are underserved by the hospital, and can guide urban and healthcare planning by pinpointing areas with inadequate access to emergency services, enabling targeted infrastructure and service improvements.</p>
<div class="cell">
<div class="sourceCode" id="cb46"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">res</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="co"># geom_point(data = random_points, aes(x = X, y = Y), col = "red") +</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">geom_sf</a></span><span class="op">(</span>data <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">kpg_sf</span>, <span class="va">district</span> <span class="op">==</span> <span class="st">"Belait"</span><span class="op">)</span>, fill <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">geom_sf</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>col <span class="op">=</span> <span class="va">duration</span><span class="op">)</span>, linewidth <span class="op">=</span> <span class="fl">1.2</span>, alpha <span class="op">=</span> <span class="fl">0.7</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">suriseri</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, y <span class="op">=</span> <span class="va">suriseri</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>, col <span class="op">=</span> <span class="st">"red3"</span>, pch <span class="op">=</span> <span class="st">"X"</span>, </span>
<span>             size <span class="op">=</span> <span class="fl">3</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_viridis.html">scale_colour_viridis_c</a></span><span class="op">(</span><span class="op">)</span> </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="2-gis_data_files/figure-html/unnamed-chunk-23-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Improving the analysis</p>
<ul>
<li>Weight analysis by populous areas. Outcalls to hospitals can be modelled using a Poisson distribution with the population as the rate parameter.</li>
<li>Use a more sophisticated routing algorithm that accounts for traffic conditions and road quality (am vs pm, weekends vs weekdays, etc.).</li>
<li>Simpler to analyse at the kampong or mukim level?</li>
</ul></section></section><section id="areal-data-multipolygons" class="level2" data-number="2.4"><h2 data-number="2.4" class="anchored" data-anchor-id="areal-data-multipolygons">
<span class="header-section-number">2.4</span> Areal data (<code>(MULTI)POLYGONS</code>)</h2>
<div class="callout callout-style-default callout-tip callout-titled" title="What we'll learn">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
What we’ll learn
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li>Represent statistical data using colour mapping symbology (choropleth)</li>
<li>Use <code><a href="https://ggplot2.tidyverse.org/reference/geom_text.html">ggplot2::geom_label()</a></code> or <code><a href="https://ggrepel.slowkow.com/reference/geom_text_repel.html">ggrepel::geom_label_repel()</a></code> to add labels to the map</li>
<li>Using a binned colour scale, e.g.&nbsp;<code>ggplot2::geom_scale_fill_viridis_b()</code>
</li>
</ul>
</div>
</div>
<p>When your study data is made up a finite number of non-overlapping areas, then you can represent them as polygons in R. This is the case for the kampong and mukim data in Brunei. As an example, let us look at the population of each kampong in Brunei. This dataset comes from the 2021 Brunei Census data <span class="citation" data-cites="deps2022population">(<a href="#ref-deps2022population" role="doc-biblioref">DEPS 2022</a>)</span></p>
<div class="cell">
<div class="sourceCode" id="cb47"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://pillar.r-lib.org/reference/glimpse.html">glimpse</a></span><span class="op">(</span><span class="va">bn_census2021</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Rows: 365
Columns: 11
$ id           &lt;dbl&gt; 1, 2, 3, 4, 5, 6, 8, 9, 10, 12, 14, 15, 16, 17, 18, 19, 2…
$ kampong      &lt;chr&gt; "Kg. Biang", "Kg. Amo", "Kg. Sibut", "Kg. Sumbiling Baru"…
$ mukim        &lt;chr&gt; "Mukim Amo", "Mukim Amo", "Mukim Amo", "Mukim Amo", "Muki…
$ district     &lt;chr&gt; "Temburong", "Temburong", "Temburong", "Temburong", "Temb…
$ population   &lt;dbl&gt; 75, 394, 192, 91, 108, 143, 199, 123, 95, 90, 92, 2427, 4…
$ pop_male     &lt;dbl&gt; 46, 218, 98, 48, 60, 68, 115, 65, 52, 46, 73, 1219, 252, …
$ pop_female   &lt;dbl&gt; 29, 176, 94, 43, 48, 75, 84, 58, 43, 44, 19, 1208, 150, 2…
$ pop_bruneian &lt;dbl&gt; 37, 280, 174, 55, 57, 64, 114, 88, 63, 35, 37, 1557, 235,…
$ pop_pr       &lt;dbl&gt; 33, 83, 17, 24, 41, 64, 64, 28, 29, 32, 2, 179, 3, 67, 32…
$ household    &lt;dbl&gt; 13, 83, 37, 23, 23, 23, 38, 26, 26, 23, 14, 517, 76, 691,…
$ occ_liv_q    &lt;dbl&gt; 13, 62, 27, 16, 22, 21, 37, 22, 12, 23, 14, 492, 71, 681,…</code></pre>
</div>
</div>
<p>Each row of the data refers to a kampong-level observation. While there are unique identifiers to this (<code>id</code>, <code>kampong</code>, <code>mukim</code>, <code>district</code>), we would still need to geocode this data set so that we can do fun things like plot it on a map. Let’s use (again) <code><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join()</a></code> to do this.</p>
<div class="cell">
<div class="sourceCode" id="cb49"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">bn_pop_sf</span> <span class="op">&lt;-</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span></span>
<span>    <span class="va">kpg_sf</span>, </span>
<span>    <span class="va">bn_census2021</span>, </span>
<span>    by <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/join_by.html">join_by</a></span><span class="op">(</span><span class="va">id</span>, <span class="va">kampong</span>, <span class="va">mukim</span>, <span class="va">district</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Great. Let’s take a look at the population column. It would be very interesting to see where most of the 440,704 people of Brunei live!</p>
<div class="cell">
<div class="sourceCode" id="cb50"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">bn_pop_sf</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">geom_sf</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="va">population</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_viridis.html">scale_fill_viridis_c</a></span><span class="op">(</span>na.value <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="2-gis_data_files/figure-html/unnamed-chunk-26-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>As expected, there are “hotspots” of population in the Brunei-Muara district, and to a lesser extent in the Belait district. We can make this graph a bit better by binning the population values. It seems to be dominated by a lot of these low value colours. Let’s take a look at this further by inspecting a histogram.</p>
<div class="cell">
<div class="sourceCode" id="cb51"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">bn_pop_sf</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_histogram.html">geom_histogram</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span><span class="va">population</span><span class="op">)</span>, binwidth <span class="op">=</span> <span class="fl">100</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Removed 75 rows containing non-finite outside the scale range
(`stat_bin()`).</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="2-gis_data_files/figure-html/unnamed-chunk-27-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>So maybe we can bin the population into 4 categories: &lt; 100, 101-1000, 1001-10000, and 10000+. For this we directly use the <code><a href="https://ggplot2.tidyverse.org/reference/scale_viridis.html">scale_fill_viridis_b()</a></code> and adjust the breaks. Otherwise we would have to <code><a href="https://rdrr.io/r/base/cut.html">cut()</a></code> the population column and then use <code><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html">scale_fill_manual()</a></code>. We also added the names of the top 10 most populous kampongs to the map using <code><a href="https://ggrepel.slowkow.com/reference/geom_text_repel.html">ggrepel::geom_label_repel()</a></code>.</p>
<div class="cell">
<div class="sourceCode" id="cb53"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">kpg_labels_sf</span> <span class="op">&lt;-</span></span>
<span>  <span class="va">bn_pop_sf</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/desc.html">desc</a></span><span class="op">(</span><span class="va">population</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/slice.html">slice_head</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">10</span><span class="op">)</span></span>
<span></span>
<span><span class="va">bn_pop_sf</span> <span class="op">|&gt;</span></span>
<span>  <span class="co"># filter(population &gt; 50) |&gt;</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">geom_sf</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="va">population</span><span class="op">)</span>, col <span class="op">=</span> <span class="cn">NA</span>, alpha <span class="op">=</span> <span class="fl">0.8</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">geom_sf</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">kpg_sf</span>, fill <span class="op">=</span> <span class="cn">NA</span>, col <span class="op">=</span> <span class="st">"black"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">ggrepel</span><span class="fu">::</span><span class="fu"><a href="https://ggrepel.slowkow.com/reference/geom_text_repel.html">geom_label_repel</a></span><span class="op">(</span></span>
<span>    data <span class="op">=</span> <span class="va">kpg_labels_sf</span>,</span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>label <span class="op">=</span> <span class="va">kampong</span>, geometry <span class="op">=</span> <span class="va">geometry</span><span class="op">)</span>,</span>
<span>    stat <span class="op">=</span> <span class="st">"sf_coordinates"</span>,</span>
<span>    inherit.aes <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>    box.padding <span class="op">=</span> <span class="fl">1</span>,</span>
<span>    size <span class="op">=</span> <span class="fl">2</span>,</span>
<span>    max.overlaps <span class="op">=</span> <span class="cn">Inf</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_viridis.html">scale_fill_viridis_b</a></span><span class="op">(</span></span>
<span>    name <span class="op">=</span> <span class="st">"Population"</span>,</span>
<span>    na.value <span class="op">=</span> <span class="cn">NA</span>,</span>
<span>    labels <span class="op">=</span> <span class="fu">scales</span><span class="fu">::</span><span class="va"><a href="https://scales.r-lib.org/reference/comma.html">comma</a></span>,</span>
<span>    breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">100</span>, <span class="fl">1000</span>, <span class="fl">10000</span>, <span class="fl">20000</span><span class="op">)</span></span>
<span>    <span class="co"># limits = c(0, 12000)</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_bw</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="2-gis_data_files/figure-html/unnamed-chunk-28-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section><section id="openstreetmap-data" class="level2" data-number="2.5"><h2 data-number="2.5" class="anchored" data-anchor-id="openstreetmap-data">
<span class="header-section-number">2.5</span> OpenStreetMap data</h2>
<div class="callout callout-style-default callout-tip callout-titled" title="What we'll learn">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
What we’ll learn
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li>How to scrape OpenStreetMap data using the <a href="https://docs.ropensci.org/osmdata/">osmdata</a> package.</li>
</ul>
</div>
</div>
<p>The <a href="https://docs.ropensci.org/osmdata/">osmdata</a> package is a very useful tool for scraping OpenStreetMap data. It allows you to download data from OpenStreetMap and convert it into an <code>sf</code> object. The package is built on top of the <code>osmdata</code> API, which is a wrapper around the Overpass API. The Overpass API is a read-only API that allows you to query OpenStreetMap data. Conveniently, we do not need an API key.</p>
<section id="example-how-to-get-all-the-schools-in-brunei" class="level3" data-number="2.5.1"><h3 data-number="2.5.1" class="anchored" data-anchor-id="example-how-to-get-all-the-schools-in-brunei">
<span class="header-section-number">2.5.1</span> EXAMPLE: How to get all the schools in Brunei</h3>
<p>When we go to https://www.openstreetmap.org/ website, we can search for some key terms. For example, if we search for “Sekolah Rendah Kiarong”, we see the following:</p>
<p><img src="figures/sr_kiarong.png" class="img-fluid"></p>
<p>Highlighted in red is the polygon that represents the school. Furthermore, we have some information in the “Tags” section such as:</p>
<ul>
<li>
<code>addr:place</code> = Kiarong</li>
<li>
<code>addr:street</code> = Jalan Datu Ratna</li>
<li>
<code>alt_name</code> = Sekolah Rendah Kiarong</li>
<li>
<code>alt_name:en</code> = Kiarong Primary School</li>
<li>
<code>amenity</code> = school</li>
<li>etc.</li>
</ul>
<p>The <a href="https://docs.ropensci.org/osmdata/">osmdata</a> package allows us to query this information. To replicate this ‘GUI’ experience using code, we do the following:</p>
<div class="cell">
<div class="sourceCode" id="cb54"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">q</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="https://docs.ropensci.org/osmdata/reference/opq.html">opq</a></span><span class="op">(</span><span class="st">"brunei"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://docs.ropensci.org/osmdata/reference/add_osm_feature.html">add_osm_feature</a></span><span class="op">(</span></span>
<span>    key <span class="op">=</span> <span class="st">"name"</span>, </span>
<span>    value <span class="op">=</span> <span class="st">"Sekolah Rendah Datu Ratna Haji Muhammad Jaafar"</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://docs.ropensci.org/osmdata/reference/osmdata_sf.html">osmdata_sf</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">q</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Object of class 'osmdata' with:
                 $bbox : 4.002508,113.017925,6.546584,115.3635623
        $overpass_call : The call submitted to the overpass API
                 $meta : metadata including timestamp and version numbers
           $osm_points : 'sf' Simple Features Collection with 16 points
            $osm_lines : NULL
         $osm_polygons : 'sf' Simple Features Collection with 1 polygons
       $osm_multilines : NULL
    $osm_multipolygons : NULL</code></pre>
</div>
</div>
<p>It has found the school. To extract the information, let’s look at the <code>$osm_polygons</code> entry:</p>
<div class="cell">
<div class="sourceCode" id="cb56"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://pillar.r-lib.org/reference/glimpse.html">glimpse</a></span><span class="op">(</span><span class="va">q</span><span class="op">$</span><span class="va">osm_polygons</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Rows: 1
Columns: 10
$ osm_id        &lt;chr&gt; "309023494"
$ name          &lt;chr&gt; "Sekolah Rendah Datu Ratna Haji Muhammad Jaafar"
$ `addr:place`  &lt;chr&gt; "Kiarong"
$ `addr:street` &lt;chr&gt; "Jalan Datu Ratna"
$ alt_name      &lt;chr&gt; "Sekolah Rendah Kiarong"
$ `alt_name:en` &lt;chr&gt; "Kiarong Primary School"
$ amenity       &lt;chr&gt; "school"
$ `name:en`     &lt;chr&gt; "Datu Ratna Haji Muhammad Jaafar Primary School"
$ source        &lt;chr&gt; "Bing; survey"
$ geometry      &lt;POLYGON [°]&gt; POLYGON ((114.9125 4.892252...</code></pre>
</div>
</div>
<p>Let’s plot it!</p>
<div class="cell">
<div class="sourceCode" id="cb58"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># warning: false</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">kpg_sf</span>, <span class="va">mukim</span> <span class="op">==</span> <span class="st">"Mukim Gadong B"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">geom_sf</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggrepel.slowkow.com/reference/geom_text_repel.html">geom_label_repel</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>label <span class="op">=</span> <span class="va">kampong</span>, geometry <span class="op">=</span> <span class="va">geometry</span><span class="op">)</span>,</span>
<span>    stat <span class="op">=</span> <span class="st">"sf_coordinates"</span>,</span>
<span>    inherit.aes <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>    box.padding <span class="op">=</span> <span class="fl">1</span>,</span>
<span>    size <span class="op">=</span> <span class="fl">3</span>,</span>
<span>    max.overlaps <span class="op">=</span> <span class="cn">Inf</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">geom_sf</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">q</span><span class="op">$</span><span class="va">osm_polygons</span>, fill <span class="op">=</span> <span class="st">"red3"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in st_point_on_surface.sfc(sf::st_zm(x)): st_point_on_surface may not
give correct results for longitude/latitude data</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="2-gis_data_files/figure-html/unnamed-chunk-31-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>We can query based on amenity type as well. For example, to get all the schools in Brunei:</p>
<div class="cell">
<div class="sourceCode" id="cb60"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Bounding box for Brunei Muara</span></span>
<span><span class="va">bm_sf</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">kpg_sf</span>, <span class="va">district</span> <span class="op">==</span> <span class="st">"Brunei Muara"</span><span class="op">)</span></span>
<span><span class="va">bm_bbox</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_bbox.html">st_bbox</a></span><span class="op">(</span><span class="va">bm_sf</span><span class="op">)</span></span>
<span></span>
<span><span class="va">q</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="https://docs.ropensci.org/osmdata/reference/opq.html">opq</a></span><span class="op">(</span><span class="va">bm_bbox</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://docs.ropensci.org/osmdata/reference/add_osm_feature.html">add_osm_feature</a></span><span class="op">(</span></span>
<span>    key <span class="op">=</span> <span class="st">"amenity"</span>, </span>
<span>    value <span class="op">=</span> <span class="st">"school"</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://docs.ropensci.org/osmdata/reference/osmdata_sf.html">osmdata_sf</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">q</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Object of class 'osmdata' with:
                 $bbox : 4.72903834429411,114.771346735899,5.04587807206061,115.138720231749
        $overpass_call : The call submitted to the overpass API
                 $meta : metadata including timestamp and version numbers
           $osm_points : 'sf' Simple Features Collection with 1321 points
            $osm_lines : NULL
         $osm_polygons : 'sf' Simple Features Collection with 153 polygons
       $osm_multilines : NULL
    $osm_multipolygons : 'sf' Simple Features Collection with 1 multipolygons</code></pre>
</div>
</div>
<p>Almost always it is a good idea to look at the polygons, instead of the points. In any case, you can always find the centroid of the polygons if you wanted to plot point data.</p>
<div class="cell">
<div class="sourceCode" id="cb62"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">schools_sf</span> <span class="op">&lt;-</span></span>
<span>  <span class="va">q</span><span class="op">$</span><span class="va">osm_polygons</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html">as_tibble</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span>  <span class="co"># these two lines convert to tibble-like object</span></span>
<span>  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_as_sf.html">st_as_sf</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">osm_id</span>, <span class="va">name</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/drop_na.html">drop_na</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_unary.html">st_centroid</a></span><span class="op">(</span><span class="op">)</span>  <span class="co"># obtains X,Y coordinates of centroids</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">schools_sf</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Simple feature collection with 138 features and 2 fields
Geometry type: POINT
Dimension:     XY
Bounding box:  xmin: 114.7891 ymin: 4.730341 xmax: 115.1303 ymax: 5.036068
Geodetic CRS:  WGS 84
# A tibble: 138 × 3
   osm_id    name                                                 geometry
 * &lt;chr&gt;     &lt;chr&gt;                                             &lt;POINT [°]&gt;
 1 45517438  Sekolah Rendah Haji Tarif                  (114.9321 4.88012)
 2 45768022  Sekolah Menengah Awang Semaun             (114.9389 4.876925)
 3 45820441  Sekolah Rendah Pengiran Anak Puteri Besar (114.9397 4.874045)
 4 45820563  Pehin Dato Jamil Primary School           (114.9473 4.873318)
 5 157197463 Sekolah Ugama Pengiran Muda Abdul Malik … (114.8709 4.848966)
 6 157489516 Sekolah Rendah Dato Marsal                (114.9576 4.961157)
 7 167974917 Chung Hwa Middle School                   (114.9445 4.894822)
 8 167974963 Sekolah Rendah Pusar Ulak                 (114.9358 4.896647)
 9 167974968 St. Andrew’s School                       (114.9372 4.896313)
10 260696860 Jerudong International School             (114.8793 4.969056)
# ℹ 128 more rows</code></pre>
</div>
<div class="sourceCode" id="cb64"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">geom_sf</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">bm_sf</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="va">mukim</span><span class="op">)</span>, alpha <span class="op">=</span> <span class="fl">0.3</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">geom_sf</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">schools_sf</span>, size <span class="op">=</span> <span class="fl">2</span><span class="op">)</span> </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="2-gis_data_files/figure-html/unnamed-chunk-33-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>From here…</p>
<ul>
<li>Visit the <a href="https://wiki.openstreetmap.org/wiki/Key:amenity?uselang=en-GB">OSM Wiki</a> to see what other amenities you can query.</li>
<li>Clearly not limited to schools – clinics, shops, movie theatres, …</li>
<li>Combine with the road data from <a href="https://github.com/riatelab/osrm">osrm</a> to calculate distances between schools and hospitals, for example.</li>
</ul>


<div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0" role="list">
<div id="ref-deps2022population" class="csl-entry" role="listitem">
DEPS. 2022. <span>“The <span>Population</span> and <span>Housing Census Report</span> (<span>BPP</span>) 2021: <span>Demographic</span>, <span>Household</span> and <span>Housing Characteristics</span>.”</span> <span>Department of Economic Planning and Statistics, Ministry of Finance and Economy, Brunei Darussalam</span>.
</div>
<div id="ref-jaafar2023data" class="csl-entry" role="listitem">
Jaafar, Salwana Md, and Rahayu Sukmaria Sukri. 2023. <span>“Data on the Physicochemical Characteristics and Texture Classification of Soil in <span>Bornean</span> Tropical Heath Forests Affected by Exotic <span>Acacia</span> Mangium.”</span> <em>Data in Brief</em> 51 (December). <a href="https://doi.org/10.1016/j.dib.2023.109670">https://doi.org/10.1016/j.dib.2023.109670</a>.
</div>
<div id="ref-pebesma2023spatial" class="csl-entry" role="listitem">
Pebesma, Edzer, and Roger Bivand. 2023. <em>Spatial <span>Data Science</span>: <span>With Applications</span> in <span>R</span></em>. 1st ed. New York: <span>Chapman and Hall/CRC</span>. <a href="https://doi.org/10.1201/9780429459016">https://doi.org/10.1201/9780429459016</a>.
</div>
</div>
</section></section></main><!-- /main --><script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script><nav class="page-navigation"><div class="nav-page nav-page-previous">
      <a href="./1-scraping_linear_reg.html" class="pagination-link" aria-label="Data Scraping and Linear Regression">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Data Scraping and Linear Regression</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./3-quanteda.html" class="pagination-link" aria-label="Quantitative analysis of textual data">
        <span class="nav-page-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Quantitative analysis of textual data</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->



</body></html>